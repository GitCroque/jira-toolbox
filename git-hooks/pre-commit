#!/bin/bash
# Pre-commit hook pour Jira CLI
# VÃ©rifie qu'aucune donnÃ©e sensible n'est sur le point d'Ãªtre commitÃ©e
#
# Installation:
#   cp git-hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Pour bypasser temporairement (en cas d'urgence):
#   git commit --no-verify

echo "ğŸ”’ Pre-commit: VÃ©rification de sÃ©curitÃ©..."

STAGED_FILES=$(git diff --cached --name-only)

if [ -z "$STAGED_FILES" ]; then
    echo "âœ… Aucun fichier staged"
    exit 0
fi

BLOCK_COMMIT=false

# VÃ©rifier les fichiers de configuration
for file in $STAGED_FILES; do
    # Bloquer les fichiers de config (sauf exemples)
    if echo "$file" | grep -qE '(^|/).*config\.json$' && ! echo "$file" | grep -q "example"; then
        echo "âŒ BLOQUÃ‰: Fichier de configuration dÃ©tectÃ©: $file"
        echo "   Les fichiers *config.json ne doivent pas Ãªtre committÃ©s !"
        BLOCK_COMMIT=true
    fi

    if echo "$file" | grep -q "credentials.json"; then
        echo "âŒ BLOQUÃ‰: Fichier credentials.json dÃ©tectÃ©: $file"
        BLOCK_COMMIT=true
    fi

    # VÃ©rifier le contenu des fichiers staged
    if [ -f "$file" ]; then
        # Chercher des tokens API
        if grep -qE '"api_token":\s*"[A-Za-z0-9+/=]{20,}"' "$file" 2>/dev/null; then
            echo "âŒ BLOQUÃ‰: Token API dÃ©tectÃ© dans: $file"
            echo "   Les tokens API ne doivent JAMAIS Ãªtre committÃ©s !"
            BLOCK_COMMIT=true
        fi

        # Chercher des patterns de credentials
        if grep -qE '"(password|secret|token|key)":\s*"[^"]{10,}"' "$file" 2>/dev/null && \
           ! echo "$file" | grep -qE '(example|test|mock)'; then
            echo "âš ï¸  AVERTISSEMENT: Credentials possibles dans: $file"
            echo "   VÃ©rifiez que ce fichier ne contient pas de vraies credentials"
        fi
    fi
done

if [ "$BLOCK_COMMIT" = true ]; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸš¨ COMMIT BLOQUÃ‰ pour des raisons de sÃ©curitÃ©"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Actions Ã  effectuer:"
    echo "  1. git reset HEAD <fichier-sensible>"
    echo "  2. Supprimez ou dÃ©placez le fichier sensible"
    echo "  3. VÃ©rifiez .gitignore"
    echo "  4. Recommencez le commit"
    echo ""
    echo "Pour bypasser ce hook (DÃ‰CONSEILLÃ‰):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

echo "âœ… VÃ©rification de sÃ©curitÃ© passÃ©e"
exit 0
